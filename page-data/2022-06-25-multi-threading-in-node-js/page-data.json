{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2022-06-25-multi-threading-in-node-js/",
    "result": {"data":{"site":{"siteMetadata":{"title":"cccv blog"}},"markdownRemark":{"id":"8ea52748-2c95-58a2-a78e-340640b676a1","excerpt":"Recently I happened to write some nodejs scripts to do some simple static analysis with babel.\nBut the program took quite some time to finish. Time for…","html":"<p>Recently I happened to write some nodejs scripts to do some simple static analysis with babel.\nBut the program took quite some time to finish. Time for optimization.</p>\n<p>We always say “nodejs is single-threaded”. And we seldom use nodejs to run code with multithreading (maybe it’s just me).\nIndeed nodejs multithreading support have been here for a while! Let’s try to make use of the threads to distribute the loads.</p>\n<p>As early as node <code class=\"language-text\">v10.5.0</code> (2018), the experimental feature <code class=\"language-text\">Worker</code> constructor was introduced for spawning workers to utilize the other cores of cpu.\nHowever the interface of it had been changing until <code class=\"language-text\">v12.17.0</code> (2020). (<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Worker/Worker\">mdn</a>)</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e21c0ea67b5d9ad852af546e88d3cd44/b2b2c/worker-constructor-nodejs-mdn.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 86.70886075949367%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAABmUlEQVQ4y61Ti27CMAzs/38lEmi06Stpm+YB9KYzuCsMEJNmyYrrxBdffC0ulwuWZRFnfDqdZM05I4Qg8fl8XvcYxxhlnzFzjJ1zcqYgkNoWmNb3vRTQ5nlGWZboug4pJQExxqBpmrvaQos1wa705qqqpBsaOzgej5Jr21Yu4zdBabyENcWWMo0H6rqWlYXWWfnWHFeCsVN2fCxLjOOItmkwe4/ika61Fh076Ho4a+Enj2EYrrm+l30CcCX44AZY62Bai9FHFIf9HrvdTmgSMKaEmBNCiuJzCoi3mJ5yQspZfI4BIQUMMeNQ92jciIK382YBvCwC5uMsTrAx+itYvgGe8uo+XQFdiPgyFeq2+aFM46OOg8PgzDqMvxjHsA5F33GaJlTGyDRVMvq+W1mpP+Z/6ZCA1JbKgw/PWKes061vE9czXF8CstDculT5fEZ5uQckRed6hNlik35K+9GfAmqHZVkJLapf32oL+qyzt4B1bda321L+GFATSnkam7Wrf6Jcyo9PLVLw9I+H8qgl773I5h3lV07ZfAO9HS/WevasFgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"worker-constructor-nodejs-mdn\"\n        title=\"worker-constructor-nodejs-mdn\"\n        src=\"/static/e21c0ea67b5d9ad852af546e88d3cd44/f058b/worker-constructor-nodejs-mdn.png\"\n        srcset=\"/static/e21c0ea67b5d9ad852af546e88d3cd44/c26ae/worker-constructor-nodejs-mdn.png 158w,\n/static/e21c0ea67b5d9ad852af546e88d3cd44/6bdcf/worker-constructor-nodejs-mdn.png 315w,\n/static/e21c0ea67b5d9ad852af546e88d3cd44/f058b/worker-constructor-nodejs-mdn.png 630w,\n/static/e21c0ea67b5d9ad852af546e88d3cd44/40601/worker-constructor-nodejs-mdn.png 945w,\n/static/e21c0ea67b5d9ad852af546e88d3cd44/78612/worker-constructor-nodejs-mdn.png 1260w,\n/static/e21c0ea67b5d9ad852af546e88d3cd44/b2b2c/worker-constructor-nodejs-mdn.png 1708w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"nodejs-worker_threads-module\" style=\"position:relative;\"><a href=\"#nodejs-worker_threads-module\" aria-label=\"nodejs worker_threads module permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nodejs <code class=\"language-text\">worker_threads</code> module</h2>\n<p>This is an example of the main thread spawning a worker.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// index.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Worker <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"worker_threads\"</span>\n\n<span class=\"token comment\">// spawn a worker</span>\n<span class=\"token keyword\">const</span> worker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./worker\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// send data to worker</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"some message from main thread\"</span><span class=\"token punctuation\">)</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">\"john\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"c\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// worker.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> parentPort <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"worker_threads\"</span>\n\nparentPort<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> value <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"worker received message:\"</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"what-kinds-of-data-can-we-send-to-workers\" style=\"position:relative;\"><a href=\"#what-kinds-of-data-can-we-send-to-workers\" aria-label=\"what kinds of data can we send to workers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What kinds of data can we send to workers?</h3>\n<p>Usually when doing multithreading, we have to be very careful in sharing data between threads.\nOtherwise weird bugs and race condition would mess up your program.</p>\n<p>So in nodejs, there is some restriction in what kinds of data can be sent to workers via <a href=\"https://nodejs.org/api/worker_threads.html#portpostmessagevalue-transferlist\"><code class=\"language-text\">postMessage</code></a>.\nAll values that are compatible with <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm\">HTML structured clone algorithm</a> are allowed.\nIt includes a wide variety of complex objects, like <code class=\"language-text\">Array</code>, <code class=\"language-text\">Date</code>, <code class=\"language-text\">Map</code>, <code class=\"language-text\">Set</code>, objects with circular reference, etc.</p>\n<p>While values like <strong>functions</strong>, DOM nodes and those “with context / metadata” are not supported, and would cause <code class=\"language-text\">DataCloneError</code> exception.</p>\n<h3 id=\"how-are-values-passed-down-to-workers\" style=\"position:relative;\"><a href=\"#how-are-values-passed-down-to-workers\" aria-label=\"how are values passed down to workers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How are values passed down to workers?</h3>\n<p>The values are cloned to the workers. So the workers can freely modify the values!</p>\n<p>But there is an exception. <code class=\"language-text\">postMessage</code> supports second function param <code class=\"language-text\">transferList</code>. which\nis a list only allows <code class=\"language-text\">ArrayBuffer</code>, <code class=\"language-text\">MessagePort</code> and <code class=\"language-text\">FileHandle</code> values.\nOnce the message is sent, the listed values are not allowed to be used by the sending side.\nIt is for some special use, so we won’t go further.</p>\n<h3 id=\"limitation-code-execution-isolation\" style=\"position:relative;\"><a href=\"#limitation-code-execution-isolation\" aria-label=\"limitation code execution isolation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Limitation: code execution isolation</h3>\n<p>From the API design of <code class=\"language-text\">worker_threads</code>, we can see that we can’t share scope of the main thread when execute code in worker.\nIf we want to pass data to workers, we have to do it explicitly, either with <code class=\"language-text\">postMessage</code> or <code class=\"language-text\">setEnvironmentData</code>.</p>\n<p>We cannot have this kind of abstraction of multithreading:</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// imaginary abstraction of defining multithreading jobs</span>\n<span class=\"token keyword\">const</span> results <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> superStream<span class=\"token punctuation\">.</span><span class=\"token function\">fromValues</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">setMaxThreads</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">runInThreads</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// expensiveComputation() is an ordinary function</span>\n            <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">expensiveComputation</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> result\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'main thread got results from workers:'</span><span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"isolated-import-in-worker\" style=\"position:relative;\"><a href=\"#isolated-import-in-worker\" aria-label=\"isolated import in worker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Isolated import in worker</h3>\n<p>For the sake of thread safety, all data sharing between threads must be explicit.\nThe import of a file in a worker is isolated from the import of the same file in the main thread / other workers.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// mutableObj.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> count<span class=\"token operator\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// worker.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> parentPort <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"worker_threads\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> obj <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./mutableObj\"</span>\n\nparentPort<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// index.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Worker <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"worker_threads\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> obj <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"./mutableObj\"</span>\n\n<span class=\"token comment\">// mutate the value from the import</span>\nobj<span class=\"token punctuation\">.</span>count <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n\n<span class=\"token comment\">// spawn a worker</span>\n<span class=\"token keyword\">const</span> worker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./worker\"</span><span class=\"token punctuation\">)</span>\n\nworker<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mssage\"</span><span class=\"token punctuation\">,</span> objFromWorker <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  assert<span class=\"token punctuation\">.</span><span class=\"token function\">deepStrictEqual</span><span class=\"token punctuation\">(</span>objFromWorker<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> count<span class=\"token operator\">:</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"threadsjs-library\" style=\"position:relative;\"><a href=\"#threadsjs-library\" aria-label=\"threadsjs library permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">threads.js</code> library</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/245b892e37a1600a8452fc6e9659f711/e7aec/threads-js-logo.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.924050632911392%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAhklEQVQI1y3OOw6BYRSE4b+1AYUd6EQhCk9EbMA1WnGJhpBQWIA9aNRWgAqdQisanaXIF2eamWROzrwZRiiigDlaqKGOCcrooRpewRQlDJFDPrpuhj3WUZywwxdnvHDFBwc8cMETR7zR8dcN9/RwEzQpN2K5HaSDyIvwFfrYoollosI47mc/Zk5DWo0y2YkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"threads.js\"\n        title=\"threads.js\"\n        src=\"/static/245b892e37a1600a8452fc6e9659f711/f058b/threads-js-logo.png\"\n        srcset=\"/static/245b892e37a1600a8452fc6e9659f711/c26ae/threads-js-logo.png 158w,\n/static/245b892e37a1600a8452fc6e9659f711/6bdcf/threads-js-logo.png 315w,\n/static/245b892e37a1600a8452fc6e9659f711/f058b/threads-js-logo.png 630w,\n/static/245b892e37a1600a8452fc6e9659f711/40601/threads-js-logo.png 945w,\n/static/245b892e37a1600a8452fc6e9659f711/78612/threads-js-logo.png 1260w,\n/static/245b892e37a1600a8452fc6e9659f711/e7aec/threads-js-logo.png 1726w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The library <a href=\"https://github.com/andywer/threads.js/\"><code class=\"language-text\">threads.js</code></a>, created in 2019, provides a higher level abstraction for doing multithreading.\nIt also supports multi platforms of nodejs, browser and electron!</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// index.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> spawn<span class=\"token punctuation\">,</span> Thread<span class=\"token punctuation\">,</span> Worker <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"threads\"</span>\n\n<span class=\"token keyword\">const</span> worker <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">spawn</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./worker\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> worker<span class=\"token punctuation\">.</span><span class=\"token function\">fib</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"main thread got result from worker:\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// worker.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> expose <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"threads/worker\"</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fib</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>n<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">&lt;=</span> <span class=\"token number\">1</span> <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token operator\">:</span> <span class=\"token function\">fib</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">fib</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">expose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> fib <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"thread-pool\" style=\"position:relative;\"><a href=\"#thread-pool\" aria-label=\"thread pool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Thread pool</h3>\n<p>Most likely you don’t want to create too many workers than the actual cpu cores you have,\notherwise the context switching overhead would reduce the overall performance.\nYou will need to maintain a pool of workers to do your jobs, which is what <code class=\"language-text\">threads.js</code> supports!</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// index.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> spawn<span class=\"token punctuation\">,</span> Pool<span class=\"token punctuation\">,</span> Worker <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"threads\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> cpus <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'os'</span>\n\n<span class=\"token keyword\">const</span> computationParams <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">let</span> results <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">const</span> poolSize <span class=\"token operator\">=</span> <span class=\"token function\">cpus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length\n<span class=\"token keyword\">const</span> pool <span class=\"token operator\">=</span> <span class=\"token function\">Pool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">spawn</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./worker\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> poolSize<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> param <span class=\"token keyword\">of</span> computationParams<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    pool<span class=\"token punctuation\">.</span><span class=\"token function\">queue</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>worker<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> worker<span class=\"token punctuation\">.</span><span class=\"token function\">expensiveComputation</span><span class=\"token punctuation\">(</span>param<span class=\"token punctuation\">)</span>\n        results<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">await</span> pool<span class=\"token punctuation\">.</span><span class=\"token function\">completed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">await</span> pool<span class=\"token punctuation\">.</span><span class=\"token function\">terminate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'main thread got results from workers:'</span><span class=\"token punctuation\">,</span> results<span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>The basic use of worker is simple enough. As for my little nodejs program, the utilization of the extra cpu cores reduced the execution time from ~2mins to 38s. Sweet.</p>","frontmatter":{"title":"Multi threading in node-js","date":"June 25, 2022","description":null}},"previous":{"fields":{"slug":"/2021-10-02-switching-applications-with-keyboard-shortcut-on-macos/"},"frontmatter":{"title":"Switching applications with keyboard shortcut on macOS"}},"next":null},"pageContext":{"id":"8ea52748-2c95-58a2-a78e-340640b676a1","previousPostId":"0bcaa5bc-159f-5b7f-aa05-7cfe4f9ffd92","nextPostId":null}},
    "staticQueryHashes": ["1776624730","3000541721","3274528899"]}